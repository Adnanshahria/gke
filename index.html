<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GkE Study Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js" type="module"></script>

    <script src="https://unpkg.com/dexie@4.0.7/dist/dexie.min.js"></script>

    <style>
        :root {
            --bg-primary: #F8F8F8;
            --bg-card: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6B6B6B;
            --border-color: #EAEAEA;
            --accent-color: #007AFF;
            --accent-color-light: #e0ecff;
            --accent-disabled: #dbeafe;
            
            --step-1-color: #34C759; /* Lecture */
            --step-2-color: #007AFF; /* 1st */
            --step-3-color: #FF9500; /* 2nd */
            --step-4-color: #AF52DE; /* 3rd */
            --step-5-color: #5856D6; /* Rev */
            --step-6-color: #FF3B30; /* Rev2 */
            
            --archive-color: #9A9A9A;
        }
        
        .dark {
            --bg-primary: #1C1C1E;
            --bg-card: #2C2C2E;
            --text-primary: #E5E5E7;
            --text-secondary: #9A9A9A;
            --border-color: #3A3A3C;
            --accent-color: #0A84FF;
            --accent-color-light: #3a3a3c;
            --accent-disabled: #3a3a3c;
            
            --step-1-color: #30D158;
            --step-2-color: #0A84FF;
            --step-3-color: #FF9F0A;
            --step-4-color: #BF5AF2;
            --step-5-color: #5E5CE6;
            --step-6-color: #FF453A;
            
            --archive-color: #6B6B6B;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior: none;
        }
        
        .bg-card { background-color: var(--bg-card); }
        .border-custom { border-color: var(--border-color); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--accent-color); }
        .bg-accent { background-color: var(--accent-color); }
        .bg-accent-light { background-color: var(--accent-color-light); }
        .placeholder-custom::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .focus-ring {
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .focus-ring:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color-light);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Sticky Table Styles */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
        }
        
        .sticky-col-1 {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: var(--bg-card);
            min-width: 40px; 
            width: 40px;
        }
        
        .sticky-col-2 {
            position: sticky;
            left: 40px; 
            z-index: 5;
            background-color: var(--bg-card);
            min-width: 180px;
        }
        
        .sticky-col-1, .sticky-col-2 {
            border-right: 1px solid var(--border-color);
        }
        
        /* 6-Step Checkbox System */
        .step-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .step-checkbox svg {
            width: 20px;
            height: 20px;
            stroke-width: 3;
            color: white;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease;
        }

        .step-checkbox.step-1 { border-color: var(--step-1-color); }
        .step-checkbox.step-2 { border-color: var(--step-2-color); }
        .step-checkbox.step-3 { border-color: var(--step-3-color); }
        .step-checkbox.step-4 { border-color: var(--step-4-color); }
        .step-checkbox.step-5 { border-color: var(--step-5-color); }
        .step-checkbox.step-6 { border-color: var(--step-6-color); }

        .step-checkbox.step-1.complete { background-color: var(--step-1-color); }
        .step-checkbox.step-2.complete { background-color: var(--step-2-color); }
        .step-checkbox.step-3.complete { background-color: var(--step-3-color); }
        .step-checkbox.step-4.complete { background-color: var(--step-4-color); }
        .step-checkbox.step-5.complete { background-color: var(--step-5-color); }
        .step-checkbox.step-6.complete { background-color: var(--step-6-color); }
        
        .step-checkbox.complete svg {
            opacity: 1;
            transform: scale(1);
        }

        .step-checkbox:not(.complete):hover {
            background-color: var(--bg-primary);
        }

        .step-checkbox.disabled {
            border-color: var(--border-color);
            background-color: var(--bg-primary);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .note-button.has-note {
            color: var(--accent-color);
            font-weight: 600;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-button.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .archived-row {
            opacity: 0.5;
            background-color: var(--bg-primary);
        }

        .target-progress-bar {
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .target-progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            transition: width 0.3s ease;
        }
        
        /* Modal animation */
        .modal {
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .modal-content {
            transition: transform 0.2s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
        }
        
        /* History Item Style */
        .history-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
        }
        .history-item.complete {
            background-color: var(--accent-color-light);
        }
        .history-item-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .history-item.complete .history-item-dot {
            background-color: var(--accent-color);
        }
        .history-item.pending .history-item-dot {
            background-color: var(--border-color);
        }
    </style>
</head>

<body class="antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="w-16 h-16 border-4 border-t-transparent border-white rounded-full animate-spin"></div>
    </div>

    <!-- MODIFIED: Changed max-w-lg to max-w-4xl for Tablet Mode -->
    <div class="max-w-4xl mx-auto p-4 space-y-4">

        <header class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-accent">GkE</h1>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-accent-light">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
            </button>
        </header>

        <section class="flex flex-col sm:flex-row gap-4">
            <div class="flex-shrink-0 relative w-32 h-32 mx-auto sm:mx-0">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle class="progress-ring-bg" stroke-width="10" cx="50" cy="50" r="45" fill="transparent"></circle>
                    <circle id="progress-ring" class="progress-ring-fg" stroke-width="10" cx="50" cy="50" r="45" fill="transparent" stroke-dasharray="282.74" stroke-dashoffset="282.74"></circle>
                </svg>
                <div id="progress-text" class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold">0%</span>
                    <span id="progress-subject" class="text-sm text-secondary"></span>
                </div>
            </div>
            <div id="subject-cards" class="flex-grow grid grid-cols-2 sm:grid-cols-1 gap-4">
            </div>
        </section>

        <section class="bg-card p-4 rounded-lg shadow space-y-2">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold">Source</h2>
                <button id="edit-source-btn" class="p-1 rounded-full hover:bg-accent-light">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-secondary">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" />
                    </svg>
                </button>
            </div>
            <p id="source-text" class="text-secondary whitespace-pre-wrap"></p>
            <input id="source-input" type="text" class="hidden w-full p-2 bg-transparent border border-custom rounded placeholder-custom" placeholder="Edit source...">
        </section>

        <!-- Target-based Card -->
        <section class="bg-card rounded-lg shadow">
            <div class="border-b border-custom">
                <!-- MODIFIED: Merged Daily and Weekly tabs -->
                <div class="flex overflow-x-auto">
                    <button class="tab-button active" data-tab="targets">My Targets</button>
                    <button class="tab-button" data-tab="custom">অনন্য</button>
                    <button class="tab-button" data-tab="history">ইতিহাস</button>
                </div>
            </div>
            
            <div class="p-4">
                <div id="tab-content">
                    <!-- MODIFIED: Renamed Daily Tab to Targets Tab -->
                    <div id="targets-tab" class="tab-content">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-secondary">অগ্রগতি</span>
                                <button class="goal-add-btn p-0.5 rounded-full hover:bg-accent-light" data-target-type="daily">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-4 h-4 text-accent">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                    </svg>
                                </button>
                            </div>
                            <span id="targets-progress-text" class="text-sm font-semibold">0%</span>
                        </div>
                        <div class="target-progress-bar mb-4">
                            <div id="targets-progress-fill" class="target-progress-fill" style="width: 0%"></div>
                        </div>
                        <div id="targets-list" class="space-y-2 max-h-60 overflow-y-auto">
                        </div>
                    </div>

                    <!-- REMOVED: Weekly Tab is merged -->

                    <!-- Custom Tab -->
                    <div id="custom-tab" class="tab-content hidden">
                        <p class="text-secondary text-sm">Custom targets coming soon...</p>
                    </div>

                    <!-- History Tab -->
                    <div id="history-tab" class="tab-content hidden">
                        <div id="history-list" class="space-y-2 max-h-60 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="w-full overflow-x-auto rounded-lg shadow bg-card">
            <!-- MODIFIED: Increased min-width for 6 new columns -->
            <table class="w-full min-w-[900px] border-collapse text-sm text-left">
                <thead class="sticky-header">
                    <tr>
                        <th class="sticky-col-1 p-3">#</th>
                        <th class="sticky-col-2 p-3">Topic</th>
                        <!-- NEW: 6-Step Columns -->
                        <th class="p-3 text-center min-w-[70px]" style="color: var(--step-1-color);">Lecture</th>
                        <th class="p-3 text-center min-w-[70px]" style="color: var(--step-2-color);">1st</th>
                        <th class="p-3 text-center min-w-[70px]" style="color: var(--step-3-color);">2nd</th>
                        <th class="p-3 text-center min-w-[70px]" style="color: var(--step-4-color);">3rd</th>
                        <th class="p-3 text-center min-w-[70px]" style="color: var(--step-5-color);">Rev</th>
                        <th class="p-3 text-center min-w-[70px]" style="color: var(--step-6-color);">Rev2</th>
                        
                        <th class="p-3 text-center min-w-[100px]">Date/Time</th>
                        <th class="p-3 text-center min-w-[60px]">Note</th>
                        <th class="p-3 text-center min-w-[120px]">Actions</th>
                    </tr>
                </thead>
                <tbody id="topics-table-body">
                </tbody>
            </table>
        </section>

    </div>

    <button id="add-topic-btn" class="bg-accent text-white w-14 h-14 rounded-full fixed bottom-6 right-6 shadow-lg flex items-center justify-center z-10">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-7 h-7">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
    </button>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
        <div class="modal-content bg-card rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h2 class="text-xl font-semibold">Settings</h2>
            
            <div>
                <label class="block text-sm font-medium text-secondary">Theme</label>
                <div class="mt-1 flex gap-2">
                    <button id="theme-light-btn" class="flex-1 p-2 rounded border border-custom">Off-White</button>
                    <button id="theme-dark-btn" class="flex-1 p-2 rounded border border-custom">Gray-Black</button>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-secondary">Sync Status</label>
                <p id="sync-status-text" class="mt-1 p-2 bg-accent-light rounded text-sm">Connecting...</p>
            </div>
            
            <!-- NEW: Subject Management -->
            <div>
                <label class="block text-sm font-medium text-secondary">Data</label>
                <button id="manage-subjects-btn" class="w-full mt-1 p-2 rounded border border-custom text-left">Manage Subjects</button>
            </div>

            <button id="settings-done-btn" class="w-full p-2 bg-accent text-white rounded font-semibold">Done</button>
        </div>
    </div>
    
    <!-- Note Modal -->
    <div id="note-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4">
        <div class="modal-content bg-card rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h2 id="note-modal-title" class="text-xl font-semibold truncate">নোট</h2>
            <textarea id="note-modal-textarea" rows="6" class="w-full p-2 bg-transparent border border-custom rounded placeholder-custom focus-ring outline-none" placeholder="Write your note here..."></textarea>
            <div class="flex gap-2">
                <button id="note-modal-cancel-btn" class="flex-1 p-2 rounded border border-custom"> বাতিল</button>
                <button id="note-modal-delete-btn" class="p-2 rounded border border-custom text-red-500 hover:bg-red-50">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                </button>
                <button id="note-modal-save-btn" class="flex-1 p-2 bg-accent text-white rounded font-semibold">সংরক্ষণ</button>
            </div>
        </div>
    </div>
    
    <!-- Add Target Modal -->
    <div id="add-target-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4">
        <div class="modal-content bg-card rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h2 id="add-target-modal-title" class="text-xl font-semibold truncate">Add to Target</h2>
            <p id="add-target-modal-topic" class="text-secondary"></p>
            <div class="flex gap-2">
                <button id="add-target-daily-btn" class="flex-1 p-2 bg-accent-light text-accent rounded font-semibold">Today</button>
                <button id="add-target-weekly-btn" class="flex-1 p-2 bg-accent-light text-accent rounded font-semibold">This Week</button>
            </div>
            <button id="add-target-cancel-btn" class="w-full p-2 rounded border border-custom">Cancel</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="modal-content bg-card rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h2 id="confirm-modal-title" class="text-xl font-semibold">Are you sure?</h2>
            <p id="confirm-modal-body" class="text-secondary"></p>
            <div class="flex gap-2">
                <button id="confirm-modal-cancel-btn" class="flex-1 p-2 rounded border border-custom">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="flex-1 p-2 bg-red-600 text-white rounded font-semibold">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Topic Add/Edit Modal (Replaces prompt()) -->
    <div id="topic-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4">
        <div class="modal-content bg-card rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h2 id="topic-modal-title" class="text-xl font-semibold">New Topic</h2>
            <div>
                <label class="block text-sm font-medium text-secondary mb-1">Topic Title</label>
                <input id="topic-modal-title-input" type="text" class="w-full p-2 bg-transparent border border-custom rounded placeholder-custom focus-ring outline-none" placeholder="Enter topic name...">
            </div>
            <div>
                <label class="block text-sm font-medium text-secondary mb-1">Date/Time (Optional)</label>
                <input id="topic-modal-datetime-input" type="text" class="w-full p-2 bg-transparent border border-custom rounded placeholder-custom focus-ring outline-none" placeholder="e.g., 3 ঘন্টা or 20 Oct">
            </div>
            <div class="flex gap-2">
                <button id="topic-modal-cancel-btn" class="flex-1 p-2 rounded border border-custom">Cancel</button>
                <button id="topic-modal-save-btn" class="flex-1 p-2 bg-accent text-white rounded font-semibold">Save</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Tick History Modal -->
    <div id="history-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4">
        <div class="modal-content bg-card rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h2 id="history-modal-title" class="text-xl font-semibold truncate">Completion History</h2>
            <div id="history-modal-list" class="space-y-2">
                <!-- History items will be injected here -->
            </div>
            <button id="history-modal-close-btn" class="w-full p-2 bg-accent text-white rounded font-semibold">Done</button>
        </div>
    </div>
    
    <!-- NEW: Subject Management Modal -->
    <div id="subject-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="modal-content bg-card rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h2 class="text-xl font-semibold">Manage Subjects</h2>
            <div id="subject-list" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- Subject list items will be injected here -->
            </div>
            <div class="space-y-2">
                <input id="subject-modal-name-input" type="text" class="w-full p-2 bg-transparent border border-custom rounded placeholder-custom focus-ring outline-none" placeholder="New subject name...">
                <input id="subject-modal-source-input" type="text" class="w-full p-2 bg-transparent border border-custom rounded placeholder-custom focus-ring outline-none" placeholder="Source (optional)...">
                <button id="subject-modal-add-btn" class="w-full p-2 bg-accent-light text-accent rounded font-semibold">Add New Subject</button>
            </div>
            <button id="subject-modal-close-btn" class="w-full p-2 rounded border border-custom">Done</button>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50">
        <span id="toast-message"></span>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            collection,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const { Dexie } = window;

        // WARNING: Your API key is visible here.
        const firebaseConfig = {
            apiKey: "AIzaSyD8K4BwqwS9vQ-eldA1F865SvSs5Fv2J4M",
            authDomain: "gkeas-f93ec.firebaseapp.com",
            projectId: "gkeas-f93ec",
            storageBucket: "gkeas-f93ec.firebasestorage.app",
            messagingSenderId: "909744549158",
            appId: "1:909744549158:web:074ea3a35181960ec3e5e7",
            measurementId: "G-BR0PX3QGZT"
        };
        
        // NEW: Constants for 6-step progress
        const PROGRESS_STEPS = {
            LECTURE: 1,
            FIRST: 2,
            SECOND: 3,
            THIRD: 4,
            REV: 5,
            REV2: 6
        };
        
        const PROGRESS_NAMES = ["", "Lecture", "1st", "2nd", "3rd", "Rev", "Rev2"];

        const app = {
            db: null,
            firestoreDB: null,
            activeSubjectId: 'gk',
            isLoading: true,
            currentNoteTopicId: null,
            currentTargetTopicId: null, 
            currentEditTopicId: null, // NEW: State for Topic modal (edit vs add)
            addTopicToTarget: null, // NEW: State for Goal Card + button
            activeTab: 'targets', // MODIFIED: Default tab is now 'targets'
            confirmCallback: null,
            
            subjects: new Map(),
            topics: new Map(),
            readings: new Map(), // This will now store 6 readings per topic
            targets: new Map(),

            listeners: []
        };
        
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            subjectCardsContainer: document.getElementById('subject-cards'),
            progressRing: document.getElementById('progress-ring'),
            progressText: document.getElementById('progress-text').firstElementChild,
            progressSubject: document.getElementById('progress-subject'),
            sourceText: document.getElementById('source-text'),
            sourceInput: document.getElementById('source-input'),
            editSourceBtn: document.getElementById('edit-source-btn'),
            topicsTableBody: document.getElementById('topics-table-body'),
            
            settingsModal: document.getElementById('settings-modal'),
            
            noteModal: document.getElementById('note-modal'),
            noteModalTitle: document.getElementById('note-modal-title'),
            noteModalTextarea: document.getElementById('note-modal-textarea'),

            addTargetModal: document.getElementById('add-target-modal'),
            addTargetModalTopic: document.getElementById('add-target-modal-topic'),

            confirmModal: document.getElementById('confirm-modal'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalBody: document.getElementById('confirm-modal-body'),
            confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'),
            confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),

            toastNotification: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message'),

            topicModal: document.getElementById('topic-modal'),
            topicModalTitle: document.getElementById('topic-modal-title'),
            topicModalTitleInput: document.getElementById('topic-modal-title-input'),
            topicModalDatetimeInput: document.getElementById('topic-modal-datetime-input'),
            topicModalCancelBtn: document.getElementById('topic-modal-cancel-btn'),
            topicModalSaveBtn: document.getElementById('topic-modal-save-btn'),
            
            historyModal: document.getElementById('history-modal'),
            historyModalTitle: document.getElementById('history-modal-title'),
            historyModalList: document.getElementById('history-modal-list'),
            historyModalCloseBtn: document.getElementById('history-modal-close-btn'),
            
            subjectModal: document.getElementById('subject-modal'),
            subjectList: document.getElementById('subject-list'),
            subjectModalNameInput: document.getElementById('subject-modal-name-input'),
            subjectModalSourceInput: document.getElementById('subject-modal-source-input'),
            subjectModalAddBtn: document.getElementById('subject-modal-add-btn'),
            subjectModalCloseBtn: document.getElementById('subject-modal-close-btn'),
        };

        let toastTimer;

        async function main() {
            showLoading(true);
            initTheme();
            
            try {
                initFirebase();
                await initDexie(); // <!-- BUGFIX: This is now fixed -->
                await loadDataFromDexie();
                await ensureDefaultSubjects();
            } catch (error) {
                console.error("Local init error:", error);
            }
            
            initFirestoreSync(); // <!-- BUGFIX: This is also fixed -->
            registerEventListeners();
            renderAll();
            showLoading(false);
        }

        function initFirebase() {
            try {
                const firebaseApp = initializeApp(firebaseConfig);
                app.firestoreDB = getFirestore(firebaseApp);
                console.log("Firebase Initialized.");
            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('sync-status-text').textContent = "Firebase Failed.";
            }
        }

        // <!-- BUGFIX: Re-added version 2 and 3 definitions with a proper .upgrade() path -->
        async function initDexie() {
            app.db = new Dexie('GkETrackerDB');
            
            // Define schema for version 2 (the old one some users might have)
            app.db.version(2).stores({
                subjects: 'id, name, source, order, updatedAt',
                topics: 'id, subjectId, title, note, order, archived, dateTime, updatedAt',
                readings: 'id, topicId, passIndex, complete, updatedAt', // Old schema with 'id' as PK
                targets: 'id, type, topicId, completed, date, updatedAt'
            });

            // Define schema for version 3 (the new one)
            app.db.version(3).stores({
                subjects: 'id, name, source, order, updatedAt',
                topics: 'id, subjectId, title, note, order, archived, dateTime, updatedAt',
                readings: '[topicId+passIndex], topicId, passIndex, complete, updatedAt', // New schema with compound PK
                targets: 'id, type, topicId, completed, date, updatedAt'
            }).upgrade(tx => {
                // This function runs only if upgrading from a version < 3.
                // The old 'readings' store (with 'id' as PK) is incompatible.
                // Safest fix: delete all old readings. They will re-sync from Firebase.
                console.log("Upgrading Dexie to v3. Clearing old 'readings' store...");
                return tx.table('readings').clear(); 
            });

            try {
                await app.db.open();
                console.log("Dexie DB Initialized.");
            } catch (error) {
                console.error("Dexie Init Error:", error);
                // If upgrade fails, it might be safer to just delete and reload
                console.warn("Dexie open failed, attempting to delete and reload.");
                await Dexie.delete('GkETrackerDB');
                await app.db.open();
                console.log("Dexie DB re-initialized after delete.");
            }
        }
        
        function initTheme() {
            const savedTheme = localStorage.getItem('gke-theme') || 'light';
            setTheme(savedTheme);
        }

        async function loadDataFromDexie() {
            console.log("Loading data from Dexie...");
            const [subjectsArr, topicsArr, readingsArr, targetsArr] = await Promise.all([
                app.db.subjects.toArray(),
                app.db.topics.toArray(),
                app.db.readings.toArray(),
                app.db.targets.toArray()
            ]);
            
            app.subjects = new Map(subjectsArr.map(s => [s.id, s]));
            app.topics = new Map(topicsArr.map(t => [t.id, t]));
            app.readings = new Map(readingsArr.map(r => [`${r.topicId}_${r.passIndex}`, r]));
            app.targets = new Map(targetsArr.map(t => [t.id, t]));
            
            if (app.subjects.size > 0 && !app.subjects.has(app.activeSubjectId)) {
                app.activeSubjectId = app.subjects.keys().next().value;
            }
        }

        async function ensureDefaultSubjects() {
            let needsLoad = false;
            if (app.subjects.size === 0) {
                needsLoad = true;
                console.log("No subjects found, creating defaults...");
                const timestamp = new Date();
                const defaultSubjects = [
                    { id: 'gk', name: 'Gk', source: 'Default Source', order: 1, updatedAt: timestamp },
                    { id: 'eng', name: 'Eng', source: 'Default Source', order: 2, updatedAt: timestamp }
                ];
                
                for (const subject of defaultSubjects) {
                    await app.db.subjects.put(subject);
                    syncToFirestore('subjects', subject.id, { ...subject, updatedAt: Timestamp.fromDate(subject.updatedAt) });
                }
            }
            
            if (needsLoad) {
                await loadDataFromDexie();
            }
        }
        
        function getActiveTopics() {
            return Array.from(app.topics.values())
                .filter(t => t.subjectId === app.activeSubjectId)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
        }

        function renderAll() {
            console.log("Rendering all components...");
            renderSubjects();
            renderProgress();
            renderSource();
            renderTopicsTable();
            renderTargets();
            renderSubjectModalList();
        }

        function renderSubjects() {
            let html = '';
            app.subjects.forEach(subject => {
                const isActive = subject.id === app.activeSubjectId;
                html += `
                    <button 
                        class="subject-card w-full p-4 rounded-lg border text-left ${isActive ? 'bg-accent text-white' : 'bg-card border-custom'}"
                        data-id="${subject.id}"
                    >
                        <span class="text-xl font-semibold">${subject.name}</span>
                        <p class="text-sm ${isActive ? 'text-white' : 'text-secondary'}">${isActive ? 'Selected' : 'Click to view'}</p>
                    </button>
                `;
            });
            DOM.subjectCardsContainer.innerHTML = html;
        }

        function renderProgress() {
            const activeTopics = getActiveTopics().filter(t => !t.archived);
            const totalPossibleReadings = activeTopics.length * 6; // 6 steps
            let completedReadings = 0;
            
            activeTopics.forEach(topic => {
                for (let i = 1; i <= 6; i++) { // Loop 1 to 6
                    const readingId = `${topic.id}_${i}`;
                    if (app.readings.has(readingId) && app.readings.get(readingId).complete) {
                        completedReadings++;
                    }
                }
            });

            const percentage = totalPossibleReadings === 0 ? 0 : Math.round((completedReadings / totalPossibleReadings) * 100);
            
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;
            DOM.progressRing.style.strokeDashoffset = offset;
            
            DOM.progressText.textContent = `${percentage}%`;
            DOM.progressSubject.textContent = app.subjects.get(app.activeSubjectId)?.name || '';
        }

        function renderSource() {
            const subject = app.subjects.get(app.activeSubjectId);
            if (subject) {
                DOM.sourceText.textContent = subject.source || '(No source set)';
                DOM.sourceInput.value = subject.source;
            }
        }

        function renderTopicsTable() {
            const topics = getActiveTopics();
            let html = '';
            
            if (topics.length === 0) {
                html = '<tr><td colspan="12" class="p-4 text-center text-secondary">No topics added for this subject.</td></tr>';
            } else {
                topics.forEach((topic, index) => {
                    const isArchived = topic.archived || false;
                    
                    const readings = [];
                    for (let i = 1; i <= 6; i++) {
                        readings[i] = app.readings.get(`${topic.id}_${i}`);
                    }
                    
                    const isComplete = (i) => readings[i]?.complete || false;

                    const isDisabled = (i) => {
                        if (i === PROGRESS_STEPS.LECTURE) return false; // Lecture always enabled
                        if (i === PROGRESS_STEPS.FIRST) return false;   // 1st always enabled
                        return !isComplete(i - 1);
                    };

                    let progressHtml = '';
                    for (let i = 1; i <= 6; i++) {
                        const complete = isComplete(i);
                        const disabled = isDisabled(i);
                        progressHtml += `
                            <td class="p-3 text-center">
                                <div 
                                    class="step-checkbox mx-auto step-${i} ${complete ? 'complete' : ''} ${disabled ? 'disabled' : ''}"
                                    data-topic-id="${topic.id}"
                                    data-pass-index="${i}"
                                    title="${PROGRESS_NAMES[i]}${disabled ? ' (Locked)' : ''}"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                            </td>
                        `;
                    }
                    
                    const hasNote = topic.note && topic.note.trim() !== '';
                    const dateTimeStr = topic.dateTime ? formatDateTime(topic.dateTime) : '';
                    
                    html += `
                        <tr class="border-b border-custom last:border-b-0 ${isArchived ? 'archived-row' : ''}">
                            <td class="sticky-col-1 p-3 text-center text-secondary">${index + 1}</td>
                            <td class="sticky-col-2 p-3 font-medium">${topic.title}</td>
                            ${progressHtml}
                            <td class="p-3 text-center text-xs text-secondary">${dateTimeStr}</td>
                            <td class="p-3 text-center">
                                <button 
                                    class="note-button text-sm ${hasNote ? 'has-note' : 'text-secondary'}"
                                    data-topic-id="${topic.id}"
                                >
                                    ${hasNote ? 'View' : 'Add'}
                                </button>
                            </td>
                            <td class="p-3 text-center">
                                <div class="flex items-center justify-center gap-1">
                                    <button class="history-btn p-1 hover:bg-accent-light rounded" data-topic-id="${topic.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-secondary">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                    <button class="edit-topic-btn p-1 hover:bg-accent-light rounded" data-topic-id="${topic.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-secondary">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" />
                                        </svg>
                                    </button>
                                    <button class="add-target-btn p-1 hover:bg-accent-light rounded" data-topic-id="${topic.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-accent">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                    <button class="archive-btn p-1 hover:bg-accent-light rounded" data-topic-id="${topic.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4" style="color: var(--archive-color)">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                                        </svg>
                                    </button>
                                    <button class="delete-topic-btn p-1 hover:bg-red-50 rounded" data-topic-id="${topic.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-red-500">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            DOM.topicsTableBody.innerHTML = html;
        }

        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay();
            // <!-- BUGFIX: Set Sunday (0) as start of week -->
            const diff = d.getDate() - day; // day 0 (Sunday) means diff = 0
            const start = new Date(d.setDate(diff));
            start.setHours(0, 0, 0, 0);
            
            const end = new Date(start);
            end.setDate(end.getDate() + 6); // Sunday + 6 days = Saturday
            end.setHours(23, 59, 59, 999);
            
            return { start, end };
        }
        
        // <!-- MODIFIED: Merged Daily/Weekly logic -->
        function renderTargets() {
            const todayStr = new Date().toDateString();
            const { start, end } = getWeekRange(new Date());

            // --- Get all active targets (Today's Daily + This Week's Weekly) ---
            const allActiveTargets = Array.from(app.targets.values())
                .filter(t => 
                    (t.type === 'daily' && new Date(t.date).toDateString() === todayStr) ||
                    (t.type === 'weekly' && t.date >= start && t.date <= end)
                );
            
            // Sort by creation date
            allActiveTargets.sort((a,b) => a.updatedAt.getTime() - b.updatedAt.getTime());
            
            const completedTargets = allActiveTargets.filter(t => t.completed).length;
            const percentage = allActiveTargets.length > 0 ? Math.round((completedTargets / allActiveTargets.length) * 100) : 0;
            
            document.getElementById('targets-progress-text').textContent = `${percentage}%`;
            document.getElementById('targets-progress-fill').style.width = `${percentage}%`;
            
            let html = '';
            if (allActiveTargets.length === 0) {
                html = '<p class="text-secondary text-sm">No targets for today or this week. Add from table or press +.</p>';
            } else {
                allActiveTargets.forEach(target => {
                    const topic = app.topics.get(target.topicId);
                    if (topic) {
                        html += renderTargetItem(target, topic);
                    }
                });
            }
            document.getElementById('targets-list').innerHTML = html;
        }

        function renderTargetItem(target, topic) {
            const subject = app.subjects.get(topic.subjectId);
            return `
                <div class="flex items-center justify-between p-2 rounded ${target.completed ? 'bg-accent-light' : 'bg-card border border-custom'}">
                    <div class="flex flex-col overflow-hidden mr-2">
                        <span class="text-sm truncate ${target.completed ? 'line-through text-secondary' : ''}">${topic.title}</span>
                        <span class="text-xs text-secondary">${subject ? subject.name : ''} - ${target.type === 'daily' ? 'Today' : 'Weekly'}</span>
                    </div>
                    <button class="toggle-target-btn p-1 flex-shrink-0" data-target-id="${target.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="${target.completed ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 ${target.completed ? 'text-accent' : 'text-secondary'}">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
            `;
        }
        
        function renderSubjectModalList() {
            let html = '';
            app.subjects.forEach(subject => {
                html += `
                    <div class="flex items-center justify-between p-2 rounded bg-accent-light">
                        <input data-id="${subject.id}" class="subject-name-input flex-grow bg-transparent font-semibold outline-none" value="${subject.name}" />
                        <button class="delete-subject-btn p-1 hover:bg-red-50 rounded" data-id="${subject.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-red-500">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                        </button>
                    </div>
                `;
            });
            DOM.subjectList.innerHTML = html;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            if (isNaN(new Date(dateStr).getTime())) {
                return dateStr;
            }
            const d = new Date(dateStr);
            const hours = d.getHours();
            const minutes = d.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const hour12 = hours % 12 || 12;
            return `${d.getDate()}/${d.getMonth() + 1} ${hour12}:${minutes}${ampm}`;
        }
        
        function formatHistoryTimestamp(date) {
            if (!date) return 'N/A';
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function registerEventListeners() {
            // Tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.add('hidden'));
                    const tabId = e.currentTarget.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                    app.activeTab = tabId;
                });
            });

            DOM.subjectCardsContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.subject-card');
                if (card) handleChangeSubject(card.dataset.id);
            });
            
            DOM.editSourceBtn.addEventListener('click', handleEditSource);
            DOM.sourceInput.addEventListener('blur', handleSaveSource);
            DOM.sourceInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') e.target.blur();
            });

            DOM.topicsTableBody.addEventListener('click', (e) => {
                const checkbox = e.target.closest('.step-checkbox');
                const noteBtn = e.target.closest('.note-button');
                const editBtn = e.target.closest('.edit-topic-btn');
                const archiveBtn = e.target.closest('.archive-btn');
                const deleteBtn = e.target.closest('.delete-topic-btn');
                const addTargetBtn = e.target.closest('.add-target-btn');
                const historyBtn = e.target.closest('.history-btn');
                
                if (checkbox && !checkbox.classList.contains('disabled')) {
                    handleToggleReadingStatus(checkbox.dataset.topicId, parseInt(checkbox.dataset.passIndex));
                } else if (checkbox && checkbox.classList.contains('disabled')) {
                    showToast("Please complete the previous step first.");
                }
                if (noteBtn) {
                    handleOpenNoteModal(noteBtn.dataset.topicId);
                }
                if (editBtn) {
                    handleOpenTopicModal(editBtn.dataset.topicId);
                }
                if (archiveBtn) {
                    handleArchiveTopic(archiveBtn.dataset.topicId);
                }
                if (deleteBtn) {
                    handleDeleteTopic(deleteBtn.dataset.topicId);
                }
                if (addTargetBtn) {
                    handleOpenAddTargetModal(addTargetBtn.dataset.topicId);
                }
                if (historyBtn) {
                    handleOpenHistoryModal(historyBtn.dataset.topicId);
                }
            });

            // MODIFIED: Listener for the merged targets list
            document.getElementById('targets-list').addEventListener('click', (e) => {
                const btn = e.target.closest('.toggle-target-btn');
                if (btn) handleToggleTarget(btn.dataset.targetId);
            });
            
            // Goal Card + Button listeners
            document.querySelectorAll('.goal-add-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleGoalCardAdd(e.currentTarget.dataset.targetType);
                });
            });
            
            document.getElementById('add-topic-btn').addEventListener('click', () => handleOpenTopicModal(null));
            
            document.getElementById('settings-btn').addEventListener('click', () => toggleSettingsModal(true));
            document.getElementById('settings-done-btn').addEventListener('click', () => toggleSettingsModal(false));
            document.getElementById('theme-light-btn').addEventListener('click', () => setTheme('light'));
            document.getElementById('theme-dark-btn').addEventListener('click', () => setTheme('dark'));

            document.getElementById('note-modal-cancel-btn').addEventListener('click', () => toggleNoteModal(false));
            document.getElementById('note-modal-save-btn').addEventListener('click', handleSaveNote);
            document.getElementById('note-modal-delete-btn').addEventListener('click', handleDeleteNote);
            
            document.getElementById('add-target-cancel-btn').addEventListener('click', () => toggleAddTargetModal(false));
            document.getElementById('add-target-daily-btn').addEventListener('click', () => handleSaveTarget('daily'));
            document.getElementById('add-target-weekly-btn').addEventListener('click', () => handleSaveTarget('weekly'));

            DOM.confirmModalCancelBtn.addEventListener('click', hideConfirmation);
            DOM.confirmModalConfirmBtn.addEventListener('click', () => {
                if (typeof app.confirmCallback === 'function') {
                    app.confirmCallback();
                }
                hideConfirmation();
            });
            
            DOM.topicModalCancelBtn.addEventListener('click', () => toggleTopicModal(false));
            DOM.topicModalSaveBtn.addEventListener('click', handleSaveTopic);
            
            DOM.historyModalCloseBtn.addEventListener('click', () => toggleHistoryModal(false));
            
            document.getElementById('manage-subjects-btn').addEventListener('click', () => toggleSubjectModal(true));
            DOM.subjectModalCloseBtn.addEventListener('click', () => toggleSubjectModal(false));
            DOM.subjectModalAddBtn.addEventListener('click', handleAddSubject);
            DOM.subjectList.addEventListener('change', (e) => {
                if(e.target.classList.contains('subject-name-input')) {
                    handleEditSubject(e.target.dataset.id, e.target.value);
                }
            });
            DOM.subjectList.addEventListener('click', (e) => {
                const btn = e.target.closest('.delete-subject-btn');
                if(btn) {
                    handleDeleteSubject(btn.dataset.id);
                }
            });
        }

        function handleChangeSubject(subjectId) {
            if (subjectId === app.activeSubjectId) return;
            app.activeSubjectId = subjectId;
            renderAll();
        }
        
        async function handleToggleReadingStatus(topicId, passIndex) {
            const readingId = `${topicId}_${passIndex}`;
            const existingReading = app.readings.get(readingId);
            const newStatus = !(existingReading?.complete || false);
            
            const updates = [];
            const timestamp = new Date();
            
            const readingData = {
                topicId: topicId,
                passIndex: passIndex,
                complete: newStatus,
                updatedAt: timestamp
            };
            updates.push(readingData);

            if (newStatus === false && passIndex >= PROGRESS_STEPS.FIRST && passIndex < PROGRESS_STEPS.REV2) {
                for (let i = passIndex + 1; i <= PROGRESS_STEPS.REV2; i++) {
                    const subsequentReadingId = `${topicId}_${i}`;
                    const subsequentReading = app.readings.get(subsequentReadingId);
                    if (subsequentReading && subsequentReading.complete) {
                        const updatedSubsequent = {
                            ...subsequentReading,
                            complete: false,
                            updatedAt: timestamp
                        };
                        updates.push(updatedSubsequent);
                    }
                }
            }

            for (const update of updates) {
                await app.db.readings.put({
                    topicId: update.topicId,
                    passIndex: update.passIndex,
                    complete: update.complete,
                    updatedAt: update.updatedAt
                });
                app.readings.set(`${update.topicId}_${update.passIndex}`, update);
                syncToFirestore('readings', `${update.topicId}_${update.passIndex}`, { 
                    complete: update.complete, 
                    updatedAt: Timestamp.fromDate(update.updatedAt) 
                });
            }

            renderProgress();
            
            const row = DOM.topicsTableBody.querySelector(`button[data-topic-id="${topicId}"]`)?.closest('tr');
            if (row) {
                const readings = [];
                for (let i = 1; i <= 6; i++) {
                    readings[i] = app.readings.get(`${topicId}_${i}`);
                }
                const isComplete = (i) => readings[i]?.complete || false;
                const isDisabled = (i) => {
                    if (i === PROGRESS_STEPS.LECTURE) return false;
                    if (i === PROGRESS_STEPS.FIRST) return false;
                    return !isComplete(i - 1);
                };
                
                for (let i = 1; i <= 6; i++) {
                    const checkbox = row.querySelector(`.step-checkbox[data-pass-index="${i}"]`);
                    if(checkbox) {
                        checkbox.classList.toggle('complete', isComplete(i));
                        checkbox.classList.toggle('disabled', isDisabled(i));
                        checkbox.title = `${PROGRESS_NAMES[i]}${isDisabled(i) ? ' (Locked)' : ''}`;
                    }
                }
            }
        }
        
        function handleOpenTopicModal(topicId) {
            app.currentEditTopicId = topicId;
            
            if (topicId) {
                const topic = app.topics.get(topicId);
                DOM.topicModalTitle.textContent = "Edit Topic";
                DOM.topicModalTitleInput.value = topic.title;
                DOM.topicModalDatetimeInput.value = topic.dateTime || '';
            } else {
                DOM.topicModalTitle.textContent = "New Topic";
                DOM.topicModalTitleInput.value = "";
                DOM.topicModalDatetimeInput.value = "";
            }
            toggleTopicModal(true);
        }
        
        async function handleSaveTopic() {
            const title = DOM.topicModalTitleInput.value.trim();
            if (!title) {
                showToast("Please enter a topic title.");
                return;
            }
            const dateTime = DOM.topicModalDatetimeInput.value.trim();
            const timestamp = new Date();
            
            let topic;
            let isNew = false;
            
            if (app.currentEditTopicId) {
                const existingTopic = app.topics.get(app.currentEditTopicId);
                topic = { 
                    ...existingTopic, 
                    title: title,
                    dateTime: dateTime, 
                    updatedAt: timestamp
                };
            } else {
                isNew = true;
                const topics = getActiveTopics();
                topic = {
                    id: generateUUID(),
                    subjectId: app.activeSubjectId,
                    title: title,
                    note: '',
                    dateTime: dateTime,
                    archived: false,
                    order: (topics.length > 0 ? Math.max(...topics.map(t => t.order || 0)) : 0) + 1,
                    updatedAt: timestamp
                };
            }
            
            await app.db.topics.put(topic);
            app.topics.set(topic.id, topic);
            
            syncToFirestore('topics', topic.id, { ...topic, updatedAt: Timestamp.fromDate(topic.updatedAt) });
            
            if (isNew && app.addTopicToTarget) {
                await handleSaveTarget(app.addTopicToTarget, topic.id);
            }
            
            toggleTopicModal(false);
            renderTopicsTable();
            if (isNew) renderProgress();
        }

        async function handleArchiveTopic(topicId) {
            const topic = app.topics.get(topicId);
            if (!topic) return;
            
            const updatedTopic = { ...topic, archived: !topic.archived, updatedAt: new Date() };
            
            await app.db.topics.put(updatedTopic);
            app.topics.set(topicId, updatedTopic);
            
            renderTopicsTable();
            renderProgress();
            
            syncToFirestore('topics', topicId, { ...updatedTopic, updatedAt: Timestamp.fromDate(updatedTopic.updatedAt) });
        }

        function handleEditSource() {
            DOM.sourceText.classList.add('hidden');
            DOM.sourceInput.classList.remove('hidden');
            DOM.sourceInput.focus();
        }
        
        async function handleSaveSource() {
            DOM.sourceText.classList.remove('hidden');
            DOM.sourceInput.classList.add('hidden');
            
            const newSource = DOM.sourceInput.value;
            const subject = app.subjects.get(app.activeSubjectId);
            
            if (subject && subject.source !== newSource) {
                const updatedSubject = { ...subject, source: newSource, updatedAt: new Date() };
                
                await app.db.subjects.put(updatedSubject);
                app.subjects.set(app.activeSubjectId, updatedSubject);
                
                renderSource();
                
                syncToFirestore('subjects', app.activeSubjectId, { ...updatedSubject, updatedAt: Timestamp.fromDate(updatedSubject.updatedAt) });
            }
        }
        
        function handleOpenNoteModal(topicId) {
            const topic = app.topics.get(topicId);
            if (!topic) return;
            
            app.currentNoteTopicId = topicId;
            DOM.noteModalTitle.textContent = `নোট: ${topic.title}`;
            DOM.noteModalTextarea.value = topic.note || '';
            toggleNoteModal(true);
        }
        
        async function handleSaveNote() {
            const topicId = app.currentNoteTopicId;
            if (!topicId) return;
            
            const topic = app.topics.get(topicId);
            const newNote = DOM.noteModalTextarea.value;
            
            if (topic.note !== newNote) {
                const updatedTopic = { ...topic, note: newNote, updatedAt: new Date() };
                
                await app.db.topics.put(updatedTopic);
                app.topics.set(topicId, updatedTopic);
                
                const btn = DOM.topicsTableBody.querySelector(`.note-button[data-topic-id="${topicId}"]`);
                if (btn) {
                    const hasNote = newNote.trim() !== '';
                    btn.textContent = hasNote ? 'View' : 'Add';
                    btn.classList.toggle('has-note', hasNote);
                }
                
                syncToFirestore('topics', topicId, { ...updatedTopic, updatedAt: Timestamp.fromDate(updatedTopic.updatedAt) });
            }
            toggleNoteModal(false);
        }

        async function handleDeleteNote() {
            const topicId = app.currentNoteTopicId;
            if (!topicId) return;

            showConfirmation(
                "Delete Note?",
                "Are you sure you want to delete this note?",
                async () => {
                    const topic = app.topics.get(topicId);
                    const updatedTopic = { ...topic, note: '', updatedAt: new Date() };
                    
                    await app.db.topics.put(updatedTopic);
                    app.topics.set(topicId, updatedTopic);
                    
                    const btn = DOM.topicsTableBody.querySelector(`.note-button[data-topic-id="${topicId}"]`);
                    if (btn) {
                        btn.textContent = 'Add';
                        btn.classList.remove('has-note');
                    }
                    
                    await syncToFirestore('topics', topicId, { ...updatedTopic, updatedAt: Timestamp.fromDate(updatedTopic.updatedAt) });
                    toggleNoteModal(false);
                    showToast("Note deleted.");
                }
            );
        }

        async function handleToggleTarget(targetId) {
            const target = app.targets.get(targetId);
            if (!target) return;
            
            const updatedTarget = { ...target, completed: !target.completed, updatedAt: new Date() };
            
            await app.db.targets.put(updatedTarget);
            app.targets.set(targetId, updatedTarget);
            
            renderTargets();
            
            syncToFirestore('targets', targetId, { ...updatedTarget, updatedAt: Timestamp.fromDate(updatedTarget.updatedAt), date: Timestamp.fromDate(updatedTarget.date) });
        }
        
        function handleOpenAddTargetModal(topicId) {
            const topic = app.topics.get(topicId);
            if (!topic) return;

            app.currentTargetTopicId = topicId;
            DOM.addTargetModalTopic.textContent = `Topic: ${topic.title}`;
            toggleAddTargetModal(true);
        }
        
        async function handleSaveTarget(type, topicId = null) {
            topicId = topicId || app.currentTargetTopicId;
            if (!topicId) return;

            const today = new Date();
            let dateKey;
            
            if (type === 'daily') {
                dateKey = today.toDateString();
            } else { // 'weekly'
                const { start } = getWeekRange(new Date());
                dateKey = `W-${start.toDateString()}`;
            }

            const targetId = `${topicId}_${dateKey}`;

            if (app.targets.has(targetId)) {
                showToast("This topic is already in that target list.");
                return;
            }

            const newTarget = {
                id: targetId,
                type: type,
                topicId: topicId,
                completed: false,
                date: today, 
                updatedAt: new Date()
            };

            await app.db.targets.put(newTarget);
            app.targets.set(targetId, newTarget);
            
            renderTargets();
            
            syncToFirestore('targets', targetId, { ...newTarget, updatedAt: Timestamp.fromDate(newTarget.updatedAt), date: Timestamp.fromDate(newTarget.date) });
            
            toggleAddTargetModal(false);
        }
        
        function handleGoalCardAdd(type) {
            app.addTopicToTarget = type;
            handleOpenTopicModal(null);
        }
        
        function handleOpenHistoryModal(topicId) {
            const topic = app.topics.get(topicId);
            if (!topic) return;

            DOM.historyModalTitle.textContent = `History: ${topic.title}`;
            
            let html = '';
            for (let i = 1; i <= 6; i++) {
                const readingId = `${topic.id}_${i}`;
                const reading = app.readings.get(readingId);
                const isComplete = reading?.complete || false;
                const timestamp = isComplete ? formatHistoryTimestamp(reading.updatedAt) : 'Pending';
                
                html += `
                    <div class="history-item ${isComplete ? 'complete' : 'pending'}">
                        <div class="history-item-dot" style="background-color: var(--step-${i}-color); opacity: ${isComplete ? '1' : '0.3'};"></div>
                        <span class="flex-grow font-semibold" style="${isComplete ? '' : 'color: var(--text-secondary);'}">${PROGRESS_NAMES[i]}</span>
                        <span class="text-xs text-secondary">${timestamp}</span>
                    </div>
                `;
            }
            DOM.historyModalList.innerHTML = html;
            
            toggleHistoryModal(true);
        }
        
        async function handleAddSubject() {
            const name = DOM.subjectModalNameInput.value.trim();
            const source = DOM.subjectModalSourceInput.value.trim();
            if (!name) {
                showToast("Please enter a subject name.");
                return;
            }
            
            const timestamp = new Date();
            const newSubject = {
                id: generateUUID(),
                name: name,
                source: source || 'No source set',
                order: app.subjects.size + 1,
                updatedAt: timestamp
            };
            
            await app.db.subjects.put(newSubject);
            app.subjects.set(newSubject.id, newSubject);
            
            syncToFirestore('subjects', newSubject.id, { ...newSubject, updatedAt: Timestamp.fromDate(timestamp) });
            
            DOM.subjectModalNameInput.value = '';
            DOM.subjectModalSourceInput.value = '';
            renderSubjectModalList();
            renderSubjects();
        }
        
        async function handleEditSubject(subjectId, newName) {
            const subject = app.subjects.get(subjectId);
            if (!subject || subject.name === newName) return;
            
            const updatedSubject = { ...subject, name: newName, updatedAt: new Date() };
            
            await app.db.subjects.put(updatedSubject);
            app.subjects.set(subjectId, updatedSubject);
            
            syncToFirestore('subjects', subjectId, { ...updatedSubject, updatedAt: Timestamp.fromDate(updatedSubject.updatedAt) });
            
            renderSubjects();
            if(subjectId === app.activeSubjectId) renderProgress();
        }
        
        async function handleDeleteSubject(subjectId) {
            if (app.subjects.size <= 1) {
                showToast("Cannot delete the last subject.");
                return;
            }
            
            const subject = app.subjects.get(subjectId);
            showConfirmation(
                "Delete Subject?",
                `Delete "${subject.name}"? All topics in this subject will also be deleted. This is irreversible.`,
                async () => {
                    await app.db.subjects.delete(subjectId);
                    app.subjects.delete(subjectId);
                    await deleteFromFirestore('subjects', subjectId);
                    
                    const topicsToDelete = Array.from(app.topics.values()).filter(t => t.subjectId === subjectId);
                    for (const topic of topicsToDelete) {
                        await handleDeleteTopic(topic.id, true); // Pass skipConfirm flag
                    }
                    
                    if (app.activeSubjectId === subjectId) {
                        app.activeSubjectId = app.subjects.keys().next().value;
                    }
                    
                    renderAll();
                    showToast(`Subject "${subject.name}" deleted.`);
                }
            );
        }
        
        async function handleDeleteTopic(topicId, skipConfirm = false) {
            const topic = app.topics.get(topicId);
            if (!topic) return;

            const deleteAction = async () => {
                await app.db.topics.delete(topicId);
                app.topics.delete(topicId);
                
                for (let i = 1; i <= 6; i++) {
                    const readingId = `${topicId}_${i}`;
                    await app.db.readings.delete([topicId, i]);
                    app.readings.delete(readingId);
                    await deleteFromFirestore('readings', readingId);
                }
                
                const targetsToDelete = [];
                for (const target of app.targets.values()) {
                    if (target.topicId === topicId) targetsToDelete.push(target.id);
                }
                for (const targetId of targetsToDelete) {
                    await app.db.targets.delete(targetId);
                    app.targets.delete(targetId);
                    await deleteFromFirestore('targets', targetId);
                }

                if (!skipConfirm) {
                    renderTopicsTable();
                    renderProgress();
                    renderTargets();
                    showToast("Topic deleted.");
                }
                await deleteFromFirestore('topics', topicId);
            };

            if (skipConfirm) {
                await deleteAction();
            } else {
                showConfirmation(
                    "Delete Topic?", 
                    `Are you sure you want to delete "${topic.title}"? This action cannot be undone.`,
                    deleteAction
                );
            }
        }

        async function syncToFirestore(collectionName, docId, data) {
            if (!app.firestoreDB) return;
            try {
                if (collectionName === 'readings') {
                    const [topicId, passIndex] = docId.split('_');
                    await setDoc(doc(app.firestoreDB, collectionName, docId), {
                        topicId: topicId,
                        passIndex: parseInt(passIndex, 10),
                        complete: data.complete,
                        updatedAt: data.updatedAt
                    });
                } else {
                    const cleanData = { ...data };
                    await setDoc(doc(app.firestoreDB, collectionName, docId), cleanData);
                }
            } catch (error) {
                console.error("Firestore Sync Error:", error);
                document.getElementById('sync-status-text').textContent = "Sync failed. Retrying...";
                showToast(`Sync Error. Check connection.`);
            }
        }
        
        async function deleteFromFirestore(collectionName, docId) {
            if (!app.firestoreDB) return;
            try {
                await deleteDoc(doc(app.firestoreDB, collectionName, docId));
            } catch (error)
            {
                console.error("Firestore Delete Error:", error);
                document.getElementById('sync-status-text').textContent = "Sync failed. Retrying...";
                showToast(`Sync Error. Check connection.`);
            }
        }

        function initFirestoreSync() {
            if (!app.firestoreDB) return;
            
            const collectionsToSync = ['subjects', 'topics', 'readings', 'targets'];
            
            app.listeners.forEach(unsubscribe => unsubscribe());
            app.listeners = [];

            console.log("Initializing Firestore real-time listeners...");
            
            collectionsToSync.forEach(collectionName => {
                const q = collection(app.firestoreDB, collectionName);
                
                const unsubscribe = onSnapshot(q, async (querySnapshot) => {
                    document.getElementById('sync-status-text').textContent = "Real-time sync active.";
                    let needsRender = false;
                    
                    for (const change of querySnapshot.docChanges()) {
                        const remoteData = change.doc.data();
                        const docId = change.doc.id;
                        
                        if (remoteData.updatedAt && remoteData.updatedAt.toDate) {
                            remoteData.updatedAt = remoteData.updatedAt.toDate();
                        }
                        if (remoteData.date && remoteData.date.toDate) {
                            remoteData.date = remoteData.date.toDate();
                        }
                        
                        let localData;
                        let dataToSave;
                        
                        if (collectionName === 'readings') {
                            const localId = `${remoteData.topicId}_${remoteData.passIndex}`;
                            localData = app.readings.get(localId);
                            dataToSave = {
                                topicId: remoteData.topicId,
                                passIndex: remoteData.passIndex,
                                complete: remoteData.complete,
                                updatedAt: remoteData.updatedAt
                            };
                        } else {
                            remoteData.id = docId;
                            dataToSave = remoteData;
                            localData = await app.db[collectionName].get(docId);
                        }
                        
                        const localTime = localData?.updatedAt?.getTime() || 0;
                        const remoteTime = remoteData.updatedAt?.getTime() || 0;

                        if (!localData || remoteTime > localTime) {
                            if (change.type === 'added' || change.type === 'modified') {
                                console.log(`Syncing remote ${collectionName}/${docId} -> local`);
                                await app.db[collectionName].put(dataToSave);
                                needsRender = true;
                            } else if (change.type === 'removed') {
                                console.log(`Syncing remote delete ${collectionName}/${docId} -> local`);
                                if (collectionName === 'readings') {
                                    // <!-- BUGFIX: Parse docId to get key for deletion -->
                                    const [topicId, passIndexStr] = docId.split('_');
                                    const passIndex = parseInt(passIndexStr, 10);
                                    if (topicId && !isNaN(passIndex)) {
                                        await app.db.readings.delete([topicId, passIndex]);
                                    } else {
                                        console.error("Could not parse key from deleted docId:", docId);
                                    }
                                } else {
                                    await app.db[collectionName].delete(docId);
                                }
                                needsRender = true;
                            }
                        }
                    }

                    if (needsRender) {
                        console.log("Data changed, reloading state and re-rendering...");
                        await loadDataFromDexie();
                        renderAll();
                    }
                }, (error) => {
                    console.error(`Firestore listener error for ${collectionName}:`, error);
                    document.getElementById('sync-status-text').textContent = "Sync disconnected. Retrying...";
                });
                
                app.listeners.push(unsubscribe);
            });
        }

        function showLoading(isLoading) {
            app.isLoading = isLoading;
            DOM.loadingOverlay.classList.toggle('hidden', !isLoading);
        }
        
        function toggleModal(modal, show) {
             if (show) {
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.style.opacity = '1';
                    modal.firstElementChild.style.transform = 'scale(1)';
                });
            } else {
                modal.style.opacity = '0';
                modal.firstElementChild.style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 200);
            }
        }
        
        function toggleSettingsModal(show) { toggleModal(DOM.settingsModal, show); }
        function toggleNoteModal(show) { 
            if (!show) app.currentNoteTopicId = null;
            toggleModal(DOM.noteModal, show); 
        }
        function toggleAddTargetModal(show) { 
            if (!show) app.currentTargetTopicId = null;
            toggleModal(DOM.addTargetModal, show); 
        }
        function toggleTopicModal(show) {
            if (!show) {
                app.currentEditTopicId = null;
                app.addTopicToTarget = null;
            }
            toggleModal(DOM.topicModal, show);
        }
        function toggleHistoryModal(show) { toggleModal(DOM.historyModal, show); }
        function toggleSubjectModal(show) { toggleModal(DOM.subjectModal, show); }

        function showConfirmation(title, body, onConfirm) {
            DOM.confirmModalTitle.textContent = title;
            DOM.confirmModalBody.textContent = body;
            app.confirmCallback = onConfirm;
            toggleModal(DOM.confirmModal, true);
        }
        function hideConfirmation() {
            app.confirmCallback = null;
            toggleModal(DOM.confirmModal, false);
        }

        function showToast(message) {
            DOM.toastMessage.textContent = message;
            DOM.toastNotification.classList.remove('hidden');
            
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                DOM.toastNotification.classList.add('hidden');
            }, 3000);
        }

        function setTheme(themeName) {
            if (themeName === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('gke-theme', themeName);
            
            document.getElementById('theme-light-btn').classList.toggle('bg-accent-light', themeName === 'light');
            document.getElementById('theme-dark-btn').classList.toggle('bg-accent-light', themeName === 'dark');
        }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
    </html>
